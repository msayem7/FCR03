"use strict";(self["webpackChunkcrf03"]=self["webpackChunkcrf03"]||[]).push([[668],{5668:function(e,a,l){l.r(a),l.d(a,{default:function(){return j}});l(4114),l(8992),l(4520),l(2577),l(3949),l(1454),l(7550),l(4603),l(7566),l(8721);var t=l(6768),i=l(4232),s=l(5130),n=l(144),o=l(1387),c=l(8082),r=l(5875);l(7642),l(8004),l(3853),l(5876),l(2475),l(5024),l(1698);const u={class:"customer-claims"},d={key:0,class:"text-center"},m={key:1},v={class:"table table-striped"},p=["onUpdate:modelValue","onBlur","disabled"];var k={__name:"CustomerClaims",props:{invoiceAliasId:String,customerAliasId:String},setup(e,{expose:a}){const l=e,o=(0,r.x)(),k=(0,n.KR)([]),g=(0,n.KR)(!1),f=e=>{const a=parseFloat(e.claim_amount);isNaN(a)?e.claim_amount=0:e.claim_amount=Math.max(0,a).toFixed(4)},y=async()=>{try{g.value=!0;const e={branch:o.selectedBranch,is_active:!0},{data:a}=await c.A.get("/master-claims/",{params:e});console.log("masterClaimsData: ",a);let t=a.map((e=>({...e,claim_amount:0,existing:!1})));if(console.log("claimsData1: ",t),console.log("props.invoiceAliasId: ",l.invoiceAliasId),l.invoiceAliasId){const{data:e}=await c.A.get(`/customer-claims/?invoice=${l.invoiceAliasId}`);console.log("customerClaimsData: ",e);const a=e.map((e=>({...e,existing:!0}))),i=new Set(a.map((e=>e.name)));t=t.filter((e=>!i.has(e.name))),k.value=[...t,...a],console.log("Edit claims.value: ",k.value)}else k.value=[...t],console.log("Add claims.value: ",k.value)}catch(e){console.error("Error fetching claims:",e),k.value=[]}finally{g.value=!1}};return(0,t.sV)((async()=>{await y()})),a({claims:k}),(e,a)=>((0,t.uX)(),(0,t.CE)("div",u,[g.value?((0,t.uX)(),(0,t.CE)("div",d,a[0]||(a[0]=[(0,t.Lk)("div",{class:"spinner-border text-primary",role:"status"},[(0,t.Lk)("span",{class:"visually-hidden"},"Loading...")],-1),(0,t.Lk)("p",{class:"mt-2"},"Loading claims...",-1)]))):((0,t.uX)(),(0,t.CE)("div",m,[(0,t.Lk)("table",v,[a[1]||(a[1]=(0,t.Lk)("thead",null,[(0,t.Lk)("tr",null,[(0,t.Lk)("th",null,"Claim Name"),(0,t.Lk)("th",null,"Claim Amount")])],-1)),(0,t.Lk)("tbody",null,[((0,t.uX)(!0),(0,t.CE)(t.FK,null,(0,t.pI)(k.value,(e=>((0,t.uX)(),(0,t.CE)("tr",{key:e.alias_id},[(0,t.Lk)("td",null,(0,i.v_)(e.claim_name),1),(0,t.Lk)("td",null,[(0,t.bo)((0,t.Lk)("input",{type:"number","onUpdate:modelValue":a=>e.claim_amount=a,onBlur:a=>f(e),class:"form-control",disabled:!e.is_active&&!e.existing},null,40,p),[[s.Jo,e.claim_amount]])])])))),128))])])]))]))}},g=l(1241);const f=(0,g.A)(k,[["__scopeId","data-v-96aa420c"]]);var y=f;const b={class:"container mt-4"},L={class:"mb-4"},h={key:0,class:"text-center"},_={class:"row g-3"},C={class:"col-md-6 form-floating"},I={class:"col-md-6 form-floating"},x=["disabled"],E={key:0,value:"",disabled:""},w=["value"],A={key:0,class:"text-danger mt-1"},D={class:"col-md-6 form-floating"},R={class:"col-md-6 form-floating"},X={class:"col-md-6 form-floating"},K=["value"],S={class:"col-md-6 form-floating"},F=["value"],B={class:"col-12"},N={class:"form-floating"},U={key:0,class:"mt-3"},V=["src"],q={key:1,class:"mt-3"},J=["src"],Q={class:"col-12"},W={class:"col-12"},O=["disabled"],$={key:0,class:"spinner-border spinner-border-sm",role:"status"};var P={__name:"CreditInvoiceEntry",setup(e){const a=(0,r.x)(),l=(0,o.lq)(),u=(0,o.rd)(),d=(0,n.KR)(!1),m=(0,n.KR)(!0),v=(0,n.KR)(!1),p=(0,n.KR)(null),k=(0,n.KR)(null),g=(0,n.KR)(null),f=(0,n.KR)(!1),P=(0,n.KR)(null),T=(0,n.KR)([]),j=(0,n.KR)(null),G=(0,n.KR)({invoice_no:"",customer:"",transaction_date:"",due_amount:0,invoice_image:null,version:1}),M=(0,t.EW)((()=>{const e=T.value.find((e=>e.alias_id===G.value.customer));return e?.grace_days||0})),Y=(0,t.EW)((()=>{if(!G.value.transaction_date)return"";const e=new Date(G.value.transaction_date);return M.value&&e.setDate(e.getDate()+M.value),e.toISOString().split("T")[0]})),z=e=>{const a=e.target.files[0];a&&(G.value.invoice_image=a,k.value=URL.createObjectURL(a),g.value=null)},H=async()=>{try{const e={is_active:!0,branch:a.selectedBranch};m.value=!0;const{data:l}=await c.A.get("/customers/",{params:e});T.value=l}catch(e){p.value="Failed to load customers. Please try again later."}finally{m.value=!1}},Z=async()=>{try{d.value=!0;const{data:e}=await c.A.get(`/credit-invoices/${P.value}/`);G.value={...e,customer:e.customer,version:e.version},e.invoice_image&&(g.value=e.invoice_image),await(0,t.dY)(),T.value.some((e=>e.alias_id===G.value.customer))||(p.value="Selected customer not found in current list")}catch(e){alert(e.response?.data?.error||"Failed to load invoice"),u.push("/credit-invoices")}finally{d.value=!1}},ee=async()=>{try{v.value=!0;const e=localStorage.getItem("workingBranch");if(!e)throw new Error("Select a branch first");const a=j.value?.claims||[],l=a.filter((e=>0!==Number(e.claim_amount)&&""!==e.claim_amount)).map((e=>({alias_id:e.alias_id,claim_amount:e.claim_amount,existing:e.existing}))),t=new FormData;t.append("version",G.value.version),t.append("claims",JSON.stringify(l)),Object.entries(G.value).forEach((([e,a])=>{"invoice_image"===e?a instanceof File&&t.append(e,a):"version"!==e&&t.append(e,a)})),t.append("branch",e);await(0,c.A)({method:f.value?"put":"post",url:f.value?`/credit-invoices/${P.value}/`:"/credit-invoices/",data:t,headers:{"Content-Type":"multipart/form-data"}});u.push("/credit-invoices")}catch(e){alert(e.response?.data?.error||e.message)}finally{v.value=!1}};return(0,t.wB)((()=>a.selectedBranch),((e,a)=>{a&&e!==a&&(alert("Branch has changed. Redirecting to invoice list."),u.push("/credit-invoices"))}),{immediate:!0}),(0,t.sV)((async()=>{await H(),l.params.aliasId&&(f.value=!0,P.value=l.params.aliasId,await Z())})),(e,a)=>{const l=(0,t.g2)("router-link");return(0,t.uX)(),(0,t.CE)("div",b,[(0,t.Lk)("h2",L,(0,i.v_)(f.value?"Edit":"Create")+" Invoice",1),d.value?((0,t.uX)(),(0,t.CE)("div",h,a[4]||(a[4]=[(0,t.Lk)("div",{class:"spinner-border text-primary",role:"status"},[(0,t.Lk)("span",{class:"visually-hidden"},"Loading...")],-1),(0,t.Lk)("p",{class:"mt-2"},"Loading invoice data...",-1)]))):((0,t.uX)(),(0,t.CE)("form",{key:1,onSubmit:(0,s.D$)(ee,["prevent"])},[(0,t.Lk)("div",_,[(0,t.Lk)("div",C,[(0,t.bo)((0,t.Lk)("input",{"onUpdate:modelValue":a[0]||(a[0]=e=>G.value.invoice_no=e),type:"text",class:"form-control",id:"invoiceNo",placeholder:" ",required:""},null,512),[[s.Jo,G.value.invoice_no]]),a[5]||(a[5]=(0,t.Lk)("label",{for:"invoiceNo"},"Invoice Number",-1))]),(0,t.Lk)("div",I,[(0,t.bo)((0,t.Lk)("select",{"onUpdate:modelValue":a[1]||(a[1]=e=>G.value.customer=e),class:"form-select",id:"customerSelect",required:"",disabled:m.value},[m.value?((0,t.uX)(),(0,t.CE)("option",E," Loading customers... ")):((0,t.uX)(),(0,t.CE)(t.FK,{key:1},[a[6]||(a[6]=(0,t.Lk)("option",{value:"",disabled:"",hidden:""},"Select a customer",-1)),((0,t.uX)(!0),(0,t.CE)(t.FK,null,(0,t.pI)(T.value,(e=>((0,t.uX)(),(0,t.CE)("option",{value:e.alias_id,key:e.alias_id},(0,i.v_)(e.name),9,w)))),128))],64))],8,x),[[s.u1,G.value.customer]]),a[7]||(a[7]=(0,t.Lk)("label",{for:"customerSelect"},"Customer",-1)),p.value?((0,t.uX)(),(0,t.CE)("div",A,(0,i.v_)(p.value),1)):(0,t.Q3)("",!0)]),(0,t.Lk)("div",D,[(0,t.bo)((0,t.Lk)("input",{"onUpdate:modelValue":a[2]||(a[2]=e=>G.value.transaction_date=e),type:"date",class:"form-control",id:"transactionDate",placeholder:" ",required:""},null,512),[[s.Jo,G.value.transaction_date]]),a[8]||(a[8]=(0,t.Lk)("label",{for:"transactionDate"},"Transaction Date",-1))]),(0,t.Lk)("div",R,[(0,t.bo)((0,t.Lk)("input",{"onUpdate:modelValue":a[3]||(a[3]=e=>G.value.due_amount=e),type:"number",step:"0.01",class:"form-control",id:"dueAmount",placeholder:" ",required:""},null,512),[[s.Jo,G.value.due_amount]]),a[9]||(a[9]=(0,t.Lk)("label",{for:"dueAmount"},"Due Amount",-1))]),(0,t.Lk)("div",X,[(0,t.Lk)("input",{value:M.value,type:"number",class:"form-control",id:"graceDays",placeholder:" ",readonly:""},null,8,K),a[10]||(a[10]=(0,t.Lk)("label",{for:"graceDays"},"Grace Days",-1))]),(0,t.Lk)("div",S,[(0,t.Lk)("input",{value:Y.value,type:"date",class:"form-control",id:"paymentDate",placeholder:" ",readonly:""},null,8,F),a[11]||(a[11]=(0,t.Lk)("label",{for:"paymentDate"},"Payment Date",-1))]),(0,t.Lk)("div",B,[(0,t.Lk)("div",N,[(0,t.Lk)("input",{type:"file",onChange:z,class:"form-control",id:"invoiceImage",placeholder:" ",accept:"image/*"},null,32),a[12]||(a[12]=(0,t.Lk)("label",{for:"invoiceImage"},"Invoice Image",-1))]),k.value?((0,t.uX)(),(0,t.CE)("div",U,[a[13]||(a[13]=(0,t.Lk)("h6",{class:"text-muted mb-2"},"Preview:",-1)),(0,t.Lk)("img",{src:k.value,class:"img-thumbnail",style:{"max-width":"300px","max-height":"200px"},alt:"Invoice preview"},null,8,V)])):(0,t.Q3)("",!0),g.value?((0,t.uX)(),(0,t.CE)("div",q,[a[14]||(a[14]=(0,t.Lk)("h6",{class:"text-muted mb-2"},"Current Invoice Image:",-1)),(0,t.Lk)("img",{src:g.value,class:"img-thumbnail",style:{"max-width":"300px","max-height":"200px"},alt:"Current invoice"},null,8,J)])):(0,t.Q3)("",!0)]),(0,t.Lk)("div",Q,[G.value.invoice_no?((0,t.uX)(),(0,t.Wv)(y,{key:0,ref_key:"customerClaimsRef",ref:j,customerAliasId:G.value.customer,invoiceAliasId:P.value},null,8,["customerAliasId","invoiceAliasId"])):(0,t.Q3)("",!0)]),(0,t.Lk)("div",W,[(0,t.Lk)("button",{type:"submit",class:"btn btn-primary me-2",disabled:v.value},[v.value?((0,t.uX)(),(0,t.CE)("span",$)):(0,t.Q3)("",!0),(0,t.eW)(" "+(0,i.v_)(v.value?"Saving...":"Save"),1)],8,O),(0,t.bF)(l,{to:"/credit-invoices",class:"btn btn-secondary"},{default:(0,t.k6)((()=>a[15]||(a[15]=[(0,t.eW)("Cancel")]))),_:1})])])],32))])}}};const T=P;var j=T}}]);
//# sourceMappingURL=668.4259aba3.js.map